---
TOCTitle: 'Управление безопасностью - август 2005 г.: Устранение угрозы вредоносных компьютеров: 802.1X или IPsec?'
Title: 'Управление безопасностью - август 2005 г.: Устранение угрозы вредоносных компьютеров: 802.1X или IPsec?'
ms:assetid: '307da22d-a469-4f40-a234-27aaec0a78ce'
ms:contentKeyID: 20219143
ms:mtpsurl: 'https://technet.microsoft.com/ru-ru/library/Cc512611(v=TechNet.10)'
---

Управление безопасностью - август 2005 г.
=========================================

### Устранение угрозы вредоносных компьютеров: 802.1X или IPsec?

Опубликовано 9 августа 2005 г.

![](/security-updates/images/Cc512611.security_technet(ru-ru,TechNet.10).jpg)

[Стив Райли (Steve Riley)](http://blogs.technet.com/steriley/default.aspx)(EN)
Старший руководитель программ
Отдел безопасности бизнеса и технологий

См. другие [колонки из серии «Управление безопасностью»](http://www.microsoft.com/technet/community/columns/secmgmt/smarch.mspx)(EN).

*(Примечание. Это новая редакция статьи, опубликованной в августе. Учитывая многочисленные комментарии, поступившие от читателей, я хотел бы прояснить мой взгляд на 802.1X, а также дать больше информации о различиях возможностей 802.1X и IPsec.)*

Вредоносные компьютеры... Это, пожалуй, один из самых опасных источников заражения сети предприятия. Вы прилагаете столько усилий, чтобы построить защищенную сеть, вы своевременно обновляете ПО и антивирусые программы на клиентских компьютерах — и все равно у вас остается подозрение, что где-то есть машины, не подчиняющиеся общим правилам, которые вызывают различные проблемы в вашей сети. Некоторые зарождающиеся технологии, такие как NAP (Network Access Protection), в ближайшем будущем обещают помочь справиться с этим бедствием, но что можно сделать уже сейчас для того, чтобы снизить — хотя бы в какой-то степени — риски, связанные с вредоносными машинами?

Все более популярным решением становится управление доступом в сеть с использованием протокола 802.1X. 802.1X ([http://standards.ieee.org/getieee802/download/802.1X-2001.pdf](http://standards.ieee.org/getieee802/download/802.1x-2001.pdf) (EN)) — это метод управления доступом через порт, определенный в качестве стандарта Институтом инженеров по электротехнике и радиоэлектронике (IEEE) и позволяющий организовать обязательную взаимную проверку подлинности между клиентом и сетью. Без проверки подлинности никакой обмен данными не разрешается. 802.1X обеспечивает проверку подлинности клиента по отношению к сети и сети по отношению к клиенту с помощью протокола EAP (Extensible Authentication Protocol, <ftp://ftp.rfc-editor.org/in-notes/rfc3748.txt> (EN)), гарантируя, что обе стороны будут обмениваться данными с известными им корреспондентами.

В качестве технологии для управления *допуском проверенных компьютеров в сеть* протокол 802.1X работает весьма успешно. Если компьютеру не разрешен обмен данными по сети, то сеть будет недоступна для данного компьютера. Компьютер должен пройти проверку подлинности — в этом случае он сможет работать в данной сети. Таков был замысел 802.1X, и этот замысел был реализован. Однако этого недостаточно для полной защиты от вредоносных компьютеров, поскольку отсутствует сквозной механизм проверки подлинности и доступа. В протоколе 802.1X для проводной связи имеется недочет, который снижает его эффективность в области предотвращения доступа в сеть вредоносных компьютеров. Я покажу, как можно организовать атаку, воспользовавшись слабым местом данного протокола.

**Принцип работы 802.1X**

Протокол 802.1X устроен так, что может работать практически в любой сети — проводной, беспроводной, сделанной из колючей проволоки и даже звуковой, в которой связь осуществляется при помощи барабанов (<http://eagle.auc.ca/~dreid> (EN)). Для работы 802.1X требуется вспомогательная инфраструктура — клиенты, коммутаторы ЛВС, точки беспроводного доступа, способные осуществлять связь по протоколу 802.1X, сервер RADIUS и база данных учетных записей (например, служба Active Directory).

Клиент, который носит название *просителя*, осуществляет первичное соединение с *агентом проверки подлинности* — коммутатором ЛВС или точкой беспроводного доступа. Агент проверки подлинности настроен так, что всем просителям предписывается использовать протокол 802.1X, а все входящие соединения, не удовлетворяющие этому требованию, игнорируются. Агент проверки подлинности предлагает просителю предъявить свои идентификационные данные, которые он затем передает на *сервер проверки подлинности* (RADIUS).

Сервер RADIUS выполняет проверку подлинности клиента, используя для этого любой необходимый механизм. Обычно для этого организуется обмен данными по протоколу EAP между просителем и сервером проверки подлинности (агент проверки подлинности служит здесь просто ретранслятором); нужный метод проверки подлинности определяется в ходе такого обмена. Обратите внимание, что сам по себе протокол EAP не определяет каких-либо мер безопасности: эти меры должны быть предусмотрены в используемых протоколах проверки подлинности. В стандартной комплектации Windows поддерживает три метода EAP:

-   **EAP-MD5.** Сервер проверки подлинности запрашивает идентификационные данные у просителя. Проситель объединяет запрос со своим идентификатором и паролем, создает хэш MD5 из всех этих данных и посылает его обратно на сервер проверки подлинности. Сервер проверки подлинности расшифровывает данные, принятые от просителя, и в случае совпадения их с исходным запросом проверка подлинности завершается успешно. Заметьте, что этот метод *не является* безопасным, поскольку связан с пересылкой пароля; Windows не допускает использования метода EAP-MD5 для *беспроводных* подключений по протоколу 802.1X .

-   **EAP-TLS.** Сервер проверки подлинности открывает сеанс TLS с просителем. Сервер посылает свой цифровой сертификат просителю, а проситель проверяет действительность этого сертификата. После этого проситель посылает свой цифровой сертификат на сервер, а тот проверяет действительность сертификата просителя. Таким образом, клиент и сеть производят взаимную проверку подлинности, и если каждая из сторон доверяет сертификату другой стороны и этот сертификат является действительным, проверка подлинности завершается успешно.

-   **Защищенный EAP (PEAP).** Обмен данными по протоколу PEAP начинается так же, как и в случае EAP: сервер проверки подлинности открывает сеанс TLS с просителем и посылает ему свой цифровой сертификат для проверки. Если проситель доверяет этому сертификату, он удостоверяет свою подлинность серверу одним из нескольких методов. В настоящее время единственным доступным методом проверки подлинности со стороны просителя в Windows является MS-CHAPv2, в котором проситель использует традиционные учетные записи (имена и пароли пользователей и компьютеров) для проверки подлинности. Это называется PEAP-EAP-MS-CHAPv2. Обратите внимание, что можно также выбрать вариант PEAP-EAP-TLS, хотя на самом деле в его использовании нет смысла. Он предусматривает открытие независимого второго сеанса TLS внутри первого; такое удвоение сеансов TLS замедляет работу по сравнению с методом EAP-TLS.

После того как сервер RADIUS проверил подлинность просителя, последнему разрешается доступ в сеть за пределы агента проверки подлинности (как вы помните, им является коммутатор ЛВС или точка беспроводного доступа). Хотя агент проверки подлинности имеет один физический сетевой порт, можно представить себе, что у него есть два виртуальных порта. Трафик от проверенных просителей проходит через контролируемый порт, который блокирует трафик от непроверенных просителей. В ходе процесса проверки подлинности агенту необходимо обмениваться данными с сервером RADIUS; этот обмен происходит через неконтролируемый порт. После успешной проверки подлинности просителя контролируемый порт переходит в подключенное состояние для данного просителя.

**Использование 802.1X для защиты проводных сетей**

Чтобы стандарт 802.1X был эффективен в проводных сетях, необходимо иметь довольно современную инфраструктуру. Все коммутаторы в вашей сети — или, по крайней мере, те, к которым подключаются серверы и клиенты — должны поддерживать 802.1X. Необходима также инфраструктура открытых ключей (PKI), если у вас ее еще нет: метод PEAP требует наличия цифрового сертификата у сервера RADIUS, а в методе EAP-TLS цифровые сертификаты должны быть у всех компьютеров. (При использовании EAP-MD5 инфраструктура открытых ключей не требуется, но я не рекомендую этот метод.) Все это может оказаться довольно дорогостоящей затеей, если использовать сертификаты, выданные сторонними центрами, поэтому я рекомендую вам сэкономить средства и самим создать корпоративный центр выдачи сертификатов Windows. Все компьютеры, присоединенные к вашему домену, будут доверять этому центру, а следовательно, и сертификатам, которые он выдает.

Все ваши клиенты должны иметь стек протоколов IP с поддержкой 802.1X — например, стек, встроенный в Windows XP. Если в настоящий момент у вас нет возможности произвести обновление до Windows XP, имеется еще один вариант: корпорация Майкрософт выпустила стек 802.1X для Windows 2000 (<http://support.microsoft.com/kb/313664> (EN)). Однако в проводных сетях 802.1X как в Windows XP, так и в Windows 2000 имеется известная проблема, возникающая при совпадении трех условий:

-   Протокол 802.1X настроен только для проверки подлинности компьютеров (а не компьютеров и пользователей)

-   Используется метод PEAP (а не EAP-TLS)

-   Срок действия пароля учетной записи вашего компьютера истек

Каков результат? Компьютер будет неспособен войти в соответствующий домен. (Это проблема с DLL-библиотекой, которую в настоящий момент практически невозможно решить без переработки стека протоколов. Она будет исправлена в Windows Vista и в Windows Server «Longhorn».) Если используемая среда соответствует приведенному выше описанию, подумайте о том, чтобы установить более длительные сроки действия машинных паролей. В действительности это не так уж опасно, поскольку эти пароли создаются случайным образом и являются весьма надежными. При использовании EAP-TLS этой проблемы не существует, поскольку проверка подлинности обрабатывается другим набором DLL-библиотек. При использовании PEAP с идентификацией компьютеров и пользователей пароль компьютера сбрасывается после успешной проверки подлинности пользователя.

А что же делать с сетевыми устройствами, не поддерживающими 802.1X — принтерами, сетевыми устройствами хранения данных или, например старым ПК с DOS, на котором работает какое-нибудь старое и никак не поддерживаемое, но, тем не менее, критически важное приложение? Помните, мотивом для внедрения стандарта 802.1X было как раз то, чтобы обмен данных по сети был возможен только для устройств, имеющих соответствующий допуск. Теперь вам необходимо сделать исключение. Но прежде нужно ответить на вопрос: допускается ли это вашей политикой безопасности? Убедитесь в этом. Кроме того, придется сделать исключение для начальной загрузки новых систем (возможно, в физически изолированном сегменте, который свободен от ограничений, накладываемых 802.1X). Имейте в виду: требование обязательного использования 802.1X сделает невозможным PXE-загрузку в сети.

**Почему использование 802.1X в проводных сетях является недостаточной мерой**

Стандарт 802.1X является идеальным фундаментом для обеспечения безопасности беспроводных сетей, что уже неоднократно было продемонстрировано в материалах конференций и документации на веб-узле корпорации Майкрософт (<http://www.microsoft.com/wifi> (EN)). Но развертывание 802.1X без каких-либо дополнительных действий по защите проводных сетей от вредоносных компьютеров имеет серьезные недостатки. Одним из таких недостатков является сложность работы с устройствами, не поддерживающими этот стандарт. Другой недостаток — отсутствие управляемости: групповая политика AD предусматривает несколько объектов для управления 802.1X в *беспроводных* сетях, а для *проводных* интерфейсов таких объектов групповой политики не существует, как не существует и опубликованных интерфейсов прикладных программ (API) для управления клиентскими компьютерами в проводных сетях 802.1X. Отсутствие таких объектов групповой политики для проводных сетей 802.1X в Windows 2000 и Windows XP обусловлено рядом причин архитектурного свойства. Ввиду отсутствия централизованного управления крупномасштабное развертывание 802.1X в среде Windows в настоящий момент неосуществимо и повлечет большие расходы на поддержку.

Наконец, в протоколе есть одно чрезвычайно важное слабое место: проверка подлинности производится только при установлении подключения (в некоторых реализациях предусмотрена периодическая повторная проверка, но она не снижает риск атаки, описываемой мною ниже). После того, как подлинность просителя проверена и порт коммутатора открыт, дальнейший обмен данными между просителем и коммутатором осуществляется без проверки подлинности. Это создает ситуацию, в которой злоумышленник может подключиться к сети. (Я хотел бы поблагодарить Святослава Пидгорного, опытного специалиста по безопасности корпорации Майкрософт, который показал мне эту уязвимость.)

Подготовка этой атаки требует физического доступа к сети, поэтому в некоторых отношениях она является эзотерической. Атакующему требуется отключить компьютер (который мы будем называть «жертвой») от порта коммутатора сети, защищенной протоколом 802.1X, подключить к порту концентратор, подключить «жертву» к концентратору, а затем к тому же концентратору подключить атакующий компьютер (который мы будем называть «тенью»). Это тривиальная задача, если атакующий физически находится на вашей территории и имеет доступ к вашим разъемам Ethernet. Как вариант, атакующий может подключить к концентратору неконтролируемую точку беспроводного доступа, а затем произвести атаку с автостоянки вашего предприятия. (Разумеется, атакующий попытается скрыть свое присутствие, отключив трансляцию SSID этой точки доступа.)

Кратковременное отключение «жертвы» от сети не помешает успеху атаки. Когда компьютер-«жертва» снова подключится к сети, он снова успешно пройдет проверку подлинности на коммутаторе. Теперь наличие на пути коммутатора не будет играть роли, поскольку в основе своей коммутатор — всего лишь удлинитель с несколькими портами. Электрическое соединение «жертвы» с коммутатором по-прежнему присутствует. Концентраторы невидимы для протокола 802.1X.

Проделав все вышеописанное, атакующий настраивает MAC-адрес и IP-адрес своего компьютера так, чтобы они совпадали с адресами компьютера-«жертвы». Быстро определить эти адреса поможет анализ пакетов. Атакующий также настраивает на своем компьютере брандмауэр, который игнорирует весь входящий трафик, не являющийся ответом на инициированные им запросы.

Теперь рассмотрим принцип работы этой атаки. *После успешной проверки подлинности компьютера-«жертвы» и открытия порта коммутатора атакующий получает доступ к ресурсам в защищенной сети.* Это происходит из-за отсутствия попакетной проверки подлинности трафика после того, как порт был открыт. Поскольку компьютер-«тень» имеет те же MAC- и IP-адреса, что и компьютер-«жертва», с точки зрения коммутатора они представляют собой один компьютер, подключенный к порту. Итак, отсутствие последующей попакетной проверки подлинности в 802.1X создает условия для только что описанной атаки. Протокол 802.1X обеспечивает проверку подлинности только для самого подключения, предполагая, что весь трафик, идущий через это подключение, является санкционированным.

Обратите внимание, что обмен данными возможен только по протоколам без сохранения состояния — например, ICMP или UDP. Таким образом, атакующий может посылать тестовые запросы командой ping на компьютеры в сети и получить временный IP-адрес от DHCP-сервера (тот же IP-адрес, что и у «жертвы»), однако он не может вести обмен данными в сети по протоколу TCP: компьютер-«жертва» будет сбрасывать любые подключения, инициированные «тенью». Вот как это происходит:

1.  Компьютер-«тень» посылает пакет SYN на сервер в защищенной сети.

2.  Сервер возвращает пакет ACK-SYN, который принимается как «тенью», так и «жертвой».

3.  Компьютер-«жертва» не ожидает этого пакета ACK-SYN, поэтому отвечает серверу пакетом RST. В это время «тень» отвечает серверу пакетом ACK.

4.  Если пакет RST «жертвы» достигает сервера первым, сервер закрывает подключение и не обрабатывает пакет ACK от «тени». Если же первым приходит пакет ACK, посланный «тенью», то соединение устанавливается, но тотчас же разрывается приходящим вслед пакетом RST от «жертвы».

У этого правила есть одно интересное исключение. Если на компьютере жертвы работает межсетевой экран, отбрасывающий входящие пакеты ACK-SYN, на которые не было запроса (а большинство межсетевых экранов настроено именно так), то «жертва» не обработает принятый на шаге 2 пакет ACK-SYN, а, следовательно, и не отправит на сервер пакет RST. Оставшаяся часть описанного выше процесса выполнена не будет, и компьютер-«тень» сможет получить полный доступ в защищенную сеть. Это единственный известный мне случай, когда наличие индивидуального межсетевого экрана на компьютере может уменьшить безопасность остальной части сети! Разумеется, это не является поводом для отказа от развертывания межсетевых экранов; выгоды от их использования значительно перевешивают вероятность фактической реализации этой атаки.

**Как следует поступать?**

Прежде всего, необходимо уяснить себе условия, в которых данная атака возможна. Беспроводные сети находятся в безопасности, поскольку сеансы 802.1X+EAP предусматривают взаимную проверку подлинности *с индивидуальными шифровальными ключами для каждого просителя* (это называется «динамический протокол WEP»). Поскольку ключи не пересылаются по сети, атака с компьютером-«тенью» не сработает: взять ключ будет просто неоткуда. «Тень» не сможет подключиться к точке доступа, к которой уже подключен компьютер-«жертва». Таким образом, в некотором смысле беспроводные сети с использованием 802.1X+EAP являются на самом деле более безопасными, чем проводные.

Если речь идет о проводной сети, необходимо подумать о том, что именно требуется защитить. Если целью является не дать вредоносным машинам заразить другие машины в сети, то необходим сквозной механизм защиты. Сам по себе протокол 802.1X не обеспечивает этого. Он, конечно, *не позволит* провести атаку типа «отказ в обслуживании» с перегрузкой полосы пропускания сети (что может быть важно для вас), хотя обычно целью таких атак являются компьютеры, а не сети. Однако протокол 802.1X оперирует одним неявным предположением — о том, что все компьютеры, которым потенциально разрешен доступ в сеть, имеют один и тот же уровень доверия. Хотя в некоторых организациях дело может обстоять именно так, в общем случае имеются разные уровни доверия к компьютерам.

Поэтому я настоятельно рекомендую для предотвращения описанной выше угрозы использовать IPsec. IPsec не позволяет злоумышленнику получить доступ к другим ресурсам, защищенным с помощью этого протокола, и дает возможность определять «зоны доверия». Защиту от указанной угрозы в данном протоколе обеспечивает именно проверка подлинности не только подключения, *но и* пакетов. Если компьютер Алисы не способен создать надлежащую связь безопасности IPsec с сервером Боба, то при всех стараниях Алиса не сможет повредить защиту компьютера Боба. Так будет, например, если компьютер Алисы вовсе не имеет доверия или находится в иной зоне доверия, чем сервер. Это работает, даже если компьютер Алисы является мобильным и не подключен напрямую к сети, поскольку настройки IPsec могут перемещаться вместе с узлом.

Разумеется, IPsec не является панацеей. Для работы с IPsec требуются узлы, поддерживающие этот протокол. Однако для большинства организаций это не должно составить проблему, поскольку в Windows протокол IPsec реализован уже достаточно давно, да и многие другие популярные операционные системы поддерживают его. (Реализация протокола IPsec в Windows способна взаимодействовать с теми стеками, которые поддерживают обмен по протоколу IKE, но не ручной ввод ключей.) IPsec не помешает злоумышленнику получить IP-адрес или обмениваться данными по вашей ЛВС — но вы, само собой, можете просто заблокировать тот порт коммутатора, с которого идет попытка атаки типа «отказ в обслуживании» на вашу сеть. Если же вы хотите предотвратить более широкий спектр угроз, возможно, вам стоит рассмотреть вариант *одновременного* развертывания 802.1X и IPsec; некоторые из наших заказчиков уже делают это.

**Что это — противостояние между IPsec и 802.1X?**

Вряд ли следует воспринимать это так. Если представить себе 802.1X как способ предотвращения входа, а IPsec — как способ предотвращения доступа, становится очевидным, что они пытаются решить проблемы вредоносных машин различными путями. Проанализируйте стоящие перед вами угрозы, определитесь со своим отношением к рискам и уясните себе различия между этими технологиями:

 
<table style="border:1px solid black;">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead>
<tr class="header">
<th style="border:1px solid black;" >IPsec</th>
<th style="border:1px solid black;" >802.1X</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="border:1px solid black;"><strong>Обеспечивает проверку подлинности подключений и пакетов, пересылаемых между компьютерами</strong></td>
<td style="border:1px solid black;"><strong>Обеспечивает проверку подлинности подключений к сети</strong></td>
</tr>
<tr class="even">
<td style="border:1px solid black;"><strong>Защищает компьютеры</strong></td>
<td style="border:1px solid black;"><strong>Защищает сети</strong></td>
</tr>
<tr class="odd">
<td style="border:1px solid black;"><strong>Позволяет определять зоны с различными уровнями доверия (по направлениям и типам трафика)</strong></td>
<td style="border:1px solid black;"><strong>Рассматривает все компьютеры как имеющие одинаковый уровень доверия</strong></td>
</tr>
<tr class="even">
<td style="border:1px solid black;"><strong>Поддерживает перемещение между сетями</strong></td>
<td style="border:1px solid black;"><strong>Применим только для компьютеров, подключенных к сети</strong></td>
</tr>
<tr class="odd">
<td style="border:1px solid black;"><strong>Не может предотвратить обмен данных по сети</strong></td>
<td style="border:1px solid black;"><strong>Предотвращает атаки типа «отказ в обслуживании» с забиванием полосы пропускания</strong></td>
</tr>
<tr class="even">
<td style="border:1px solid black;"><strong>Не позволяет вредоносным компьютерам выполнять какие-либо действия в свою пользу</strong></td>
<td style="border:1px solid black;"><strong>Неспособен предотвратить атаки вредоносных компьютеров</strong></td>
</tr>
<tr class="odd">
<td style="border:1px solid black;"><strong>Не защищает от «доверенных» злоумышленников</strong></td>
<td style="border:1px solid black;"><strong>Не защищает от «доверенных» злоумышленников</strong></td>
</tr>
</tbody>
</table>
  
И все же нельзя полагаться только на 802.1X, если вы хотите предотвратить заражение вредоносными компьютерами других компьютеров в вашей сети. С ростом популярности мобильных компьютеров и беспроводных сетей стало еще важнее, чтобы каждый компьютер взял на себя работу по защите от других компьютеров в сети. Защита узлов перестала быть факультативной мерой: теперь ее можно сочетать с защитой сети. Минимальным требованием для защиты от рассматриваемой угрозы является IPsec, а внедрив дополнительно 802.1X, можно защититься от более широкого спектра опасностей.
  
**Дополнительные сведения**
  
Корпорация Майкрософт произвела переоценку угроз для своих информационных активов. По результатам этой переоценки мы определили два основополагающих требования к безопасности в нашей сети:
  
-   Защита ценной интеллектуальной собственности и соблюдение законодательных требований
  
-   Защита управляемых узлов от атак и несанкционированного доступа
  
Чтобы удовлетворить эти требования, мы использовали протокол IPsec в своей корпоративной сети для реализации того, что мы называем изоляцией доменов. В нашем случае это оказался эффективный метод, и мы рекомендуем вам его опробовать. Данный метод позволяет требовать членства в домене от всех компьютеров и даже ограничивать доступ к некоторым ресурсам, предоставляя его только конкретным группам компьютеров с высоким уровнем доверия. Дополнительную информацию об этом можно получить здесь:
  
-   [Повышение безопасности путем изоляции доменов](http://www.microsoft.com/technet/itsolutions/msit/security/ipsecdomisolwp.mspx)(EN)
  
-   [Изоляция серверов и доменов с помощью IPsec и групповой политики](http://www.microsoft.com/technet/security/topics/architectureanddesign/ipsec)(EN)
  
Кроме того, информацию по этой теме можно найти, выполнив поиск на веб-узле Microsoft.com по словосочетанию «domain isolation». Принципы, которые мы описываем в документах, посвященных изоляции доменов, образуют фундамент зарождающихся технологий [NAP (Network Access Protection)](http://www.microsoft.com/nap) (EN) в операционной системе Windows Server «Longhorn». NAP задает четыре уровня карантина: DHCP, VPN, 802.1X и IPsec. Важно начать планирование уже сегодня. Реализовав изоляцию доменов на базе IPsec в своей сети сегодня, вы сделаете заметный шаг на пути к совершенствованию методов изоляции и проверки работоспособности клиентов в будущем.
  
[](#mainsection)[К началу страницы](#mainsection)
