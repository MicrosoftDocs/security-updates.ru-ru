---
TOCTitle: Поддержка Журнала базы данных
Title: Поддержка Журнала базы данных
ms:assetid: 'de55058b-0d1a-4997-8a45-e14678ddd13f'
ms:contentKeyID: 18124567
ms:mtpsurl: 'https://technet.microsoft.com/ru-ru/library/Cc747691(v=WS.10)'
---

Поддержка Журнала базы данных
=============================

Записи журналов содержат, кроме всего прочего, копии лицензий, выданных для различных операций службы управления правами, например регистрации пользователей и назначении лицензий на использование. В наихудшей ситуации — когда каждая запись журнала является успешной регистрацией пользователя или успешной попыткой получить лицензию на использование — каждая запись добавит около 200 кБ к объему базы данных журналов.

Пусть, например, защищенное с помощью управления правами сообщение электронной почты отправлено всем сотрудникам компании, в которой работает 50 000 пользователей, и каждый пользователь открывает его. Если каждый сотрудник открыл это сообщение электронной почты в течение дня, объем базы данных журналов вырастет на 10 ГБ. Можно настроить прослушиватель не регистрировать определенные данные XrML, что уменьшит объем заносимой в журналы информации.

Обсудите возможность создания сценариев архивирования более ранней информации из базы данных журналов во вторичной базе данных. Примеры сценариев для журналов имеются в наборе инструментов для службы управления правами RMS Toolkit, который доступен для бесплатной загрузки с [веб-узла корпорации Майкрософт](http://go.microsoft.com/fwlink/?linkid=26724) (http://go.microsoft.com/fwlink/?LinkId=26724).

Переменные, влияющие на рост базы данных журналов
-------------------------------------------------

Прогнозируемый объем базы данных журналов зависит от среды. Можно прогнозировать появление в журнале некоторых “пусковых” записей, в число которых входят:

-   Регистрация сервера службы управления правами
-   Регистрация пользователя (один запрос на каждый компьютер, используемый каждым пользователем)
-   Автоматические запросы пользователей на автономные сертификаты публикации

Группа записей в базе данных журнала после пусковых записей относится к выпуску лицензий на использование для защищенного содержимого. На рост базы данных влияет несколько условий:

-   Требование новой лицензии каждый раз при доступе пользователя к защищенному содержимому. Этот метод не принят по умолчанию для защищенных документов, он является дополнительным. Если выбрать выполнение этого требования, базы данных будут расти быстрее.
-   Ожидаемое число защищенных сообщений электронной почты, отправленных каждому получателю за день.
-   Ожидаемое число уникальных пользователей, которые прочитают эти защищенные сообщения электронной почты.
-   Ожидаемое число защищенных документов Microsoft Office 2003 (Word, PowerPoint и Excel), создаваемых каждым сотрудником за день.
-   Ожидаемое число получателей защищенных документов.

Начальный размер базы данных журналов будет около 1,7 МБ; в этот объем входит запрос на сертификат сервера управления правами. Каждый раз при регистрации нового пользователя он получает сертификат учетной записи управления правами (RAC) и сертификат лицензиара клиента (CLC). Эти две операции заносятся в журнал, увеличивая его объем на 0,06 МБ. Каждый раз при успешном получении пользователем лицензии на защищенное содержимое база данных увеличивается на 0,19 МБ.

Чтобы рассмотреть работу этой схемы оценивания, рассмотрим организацию, разворачивающую систему управления правами с 5 000 пользователями. У каждого пользователя один компьютер, а у организации два сервера службы управления правами. После развертывания каждый пользователь в среднем создает одно защищенное с помощью управления правами сообщение электронной почты в день, которое отправляется пяти другим пользователям. Кроме того, каждый пользователь создает один защищенный с помощью управления правами документ за день, который используется тремя другими пользователями. В приведенной ниже таблице оценено, насколько эти операции увеличивают объем базы данных журналов.

###  

 
<table style="border:1px solid black;">
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead>
<tr class="header">
<th style="border:1px solid black;" >Операция</th>
<th style="border:1px solid black;" >Рост объема журнала</th>
<th style="border:1px solid black;" >Суммарный размер журнала</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="border:1px solid black;">Успешная подготовка сервера управления правами</td>
<td style="border:1px solid black;">1,7 МБ</td>
<td style="border:1px solid black;">1,7 МБ</td>
</tr>
<tr class="even">
<td style="border:1px solid black;">Регистрация 5000 сотрудников (5000*0,06)</td>
<td style="border:1px solid black;">300 МБ</td>
<td style="border:1px solid black;">301,7 МБ</td>
</tr>
<tr class="odd">
<td style="border:1px solid black;">Доступ к защищенным сообщениям электронной почты (25000*0,19)</td>
<td style="border:1px solid black;">4750 МБ</td>
<td style="border:1px solid black;">5051,7 МБ</td>
</tr>
<tr class="even">
<td style="border:1px solid black;">Доступ к защищенным документам (15000*0,19)</td>
<td style="border:1px solid black;">2850 МБ</td>
<td style="border:1px solid black;">7901,7 МБ</td>
</tr>
</tbody>
</table>
  
Таким образом, после регистрации база данных имеет постоянный размер около 300 МБ. Однако рост за день в этом примере составляет 7,6 ГБ — близко к ограничению в 8 ГБ для установки по умолчанию службы очередей сообщений. Если база данных журналов станет недоступной более чем на день, записи журналов начнут теряться.
  
Контроль за размером базы данных журналов  
-----------------------------------------
  
В план развертывания необходимо включить метод управления размером базы данных журналов. Ниже приведены наиболее употребительные приемы.
  
-   **Удаление и архивирование**  
    Этот метод требует использования сценариев SQL Server для архивирования выбранной информации из базы данных журналов во вторичной базе данных после того, как записи достигнут определенного возраста. Кроме того, он требует фильтрации базы данных от посторонней информации, чтобы на нее не тратилось место.  
-   **Ограничение информации, заносимой в журнал**  
    База данных журналов состоит из трех основных таблиц. Одна из них **DRMS\_Log\_Filter**, которая определяет, какое поле в главной таблице следует занести в журнал, когда включена фильтрация журнала.  
    Включающие и отключающие записи определяют, какие поля главной таблицы заносятся в журнал службой прослушивателя на сервере управления правами. Два из этих полей (по отношению к XrML) уже установлены в 0 для отключения занесения в журнал, так как эти два поля отвечают примерно за 99% размера каждой записи о запросе лицензии.  
    Другая таблица в базе данных **DRMS\_Config\_ServerName\_Port**, называемая **DRMS\_ClusterPolicies**, содержит **PolicyName** для параметра **LoggingFiltering**. Параметр **LoggingFiltering** по умолчанию не включен. Если изменить значение параметра **LoggingFiltering** на 1 и перезапустить службу прослушивателя, в приведенном выше примере дневной рост базы данных журналов уменьшится с 7,6 ГБ примерно до 160 МБ.  
-   **Перемещение базы данных журналов**  
    Другим вариантом управления растущей базы данных журналов может являться просто ее перемещение на сервер с большим объемом свободного места на диске. База данных журналов и конфигурационная база данных могут храниться на разных серверах. Для перемещения базы данных на другой сервер выполните следующие шаги:  
    1.  Остановите службу прослушивателя на каждом сервере управления правами.  
    2.  Скопируйте базу данных на другой сервер (или создайте новую).  
    3.  Измените базу данных **DRMS\_Config\_ServerName\_Port** службы управления правами, выбрав таблицу **DRMS\_ClusterPolicies** и изменив значения полей **LoggingDatabaseName** (имя сервера базы данных) и **LoggingDatabaseServer** (имя базы данных).  
    4.  Перезапустите службу IIS, запустив IISRESET.exe из командной строки.
