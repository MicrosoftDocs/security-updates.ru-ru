---
TOCTitle: Трудности при администрировании службы управления правами
Title: Трудности при администрировании службы управления правами
ms:assetid: '97013c08-d3fa-4ea0-8914-995b6c97f900'
ms:contentKeyID: 18124470
ms:mtpsurl: 'https://technet.microsoft.com/ru-ru/library/Cc747605(v=WS.10)'
---

Трудности при администрировании службы управления правами
=========================================================

Когда на сервере успешно подготовлена служба управления правами, при повседневном администрировании службы управления правами могут встретиться проблемы. Для разрешения этих проблем можно использовать информацию из следующих разделов.

При попытке открыть веб-узел администрирования службы управления правами выдается сообщение "Сервер SQL не существует или доступ запрещен"
------------------------------------------------------------------------------------------------------------------------------------------

Если служба управления правами установлена с использованием в качестве сервера базы данных новой установки SQL Server 2005, возможно, служба сервера SQL не запустится. В SQL Server 2005 служба MSSQLSERVER не настраивается для автоматического запуска при запуске сервера. Если при установке служба управления правами вы перезапустили сервер SQL и не настроили эту службу на автоматический перезапуск, то служба управления правами не сможет работать, и будет доступна только страница глобального администрирования службы управления правами.

После запуска службы MSSQLSERVER для восстановления функций служба управления правами необходимо перезапустить IIS на сервере службы управления правами.

Не удается завершить процесс автономной регистрации
---------------------------------------------------

Если файл запроса на регистрацию неполон или изменен перед отправкой на веб-узел службы регистрации, автономная регистрация не может быть завершена. Возможно, файл запроса на регистрацию поврежден вредоносной программой, из-за ошибки пользователя или из-за системной ошибки.

В зависимости от недостающей информации веб-узел службы регистрации может все же принять файл и вернуть сертификат лицензиара сервера или же отказаться принимать файл запроса и сообщить об ошибке.

Если возвращен сертификат лицензиара сервера, в нем будут отражены все пропуски или повреждения, имеющиеся в запросе на регистрацию, и при попытке импорта этого сертификата служба управления правами сообщит об ошибке.

Если не удается завершить процесс автономной регистрации, проверьте подключенный к Интернету компьютер на наличие вирусов, повторите экспорт файла запроса на регистрацию с сервера службы управления правами воспользуйтесь другим носителем для переноса его на подключенный к Интернету компьютер. При повторении ошибки следует связаться со службой технической поддержки Microsoft.

Не создаются файлы журналов
---------------------------

Работа службы регистрации службы управления правами требует как службы очередей сообщений (MSMQ), так и наличия доступа к базе данных журналов. Если файлы журналов не создаются, это может означать, что компоненты настроены неправильно, и связь между компонентами прерывается.

Убедитесь, что сетевое соединение между сервером службы управления правами и сервером базы данных работает нормально. После этого используйте приведенные ниже указания для проверки необходимых условий для службы ведения журналов управления правами и убедитесь, что все зависимости программного обеспечения настроены правильно.

Во-первых, проверьте правильность настройки службы очередей сообщений. Служба MSMQ должна быть установлена с включенной интеграцией с Active Directory.

**Для проверки правильности установки и настройки MSMQ**
1.  В **Панели управления** выберите **Установка и удаление программ** и далее **Установка компонентов Windows** для запуска **мастера компонентов Windows**.

2.  В **мастере компонентов Windows** установите флажок **Сервер приложений** и нажмите кнопку **Состав...**.

3.  Установите флажок **Очередь сообщений** и нажмите кнопку **Состав...**.

4.  Если флажок **Интеграция с Active Directory** установлен, переходите к следующей проверке и убедитесь, что служба очередей сообщений работает. Если флажок снят, выполните шаги с 5 по 9.

5.  В меню **Пуск** выберите **Все программы**, **Служба управления правами Windows**, а затем выберите **Администрирование службы управления правами**, чтобы открыть страницу Глобальное администрирование.

6.  Рядом с веб-узлом, на котором подготовлена служба управления правами, щелкните **Удалить службу управления правами с этого веб-узла**, а затем нажмите кнопку **ОК**.

7.  В окне **Установка и удаление программ** в **панели управления** щелкните **Установка компонентов Windows**, выберите **Сервер приложений**, а затем щелкните **Служба очередей сообщений**.

8.  Чтобы включить **интеграцию с Active Directory**, нажмите кнопку **Состав...**, установите флажок **Интеграция с Active Directory** и нажмите кнопку **ОК**.

9.  Откройте **страницу Глобальное администрирование**. Рядом с именем веб-узла, на котором необходимо подготовить службу управления правами, щелкните **Подготовить службу управления правами на этом веб-узле**.

Во-вторых, проверьте, что служба очередей сообщений на сервере работает.

**Для проверки работы службы очередей сообщений**
1.  В **Панели управления** выберите **Администрирование** и далее **Службы**.

2.  Прокрутите список служб и найдите службу **Очереди сообщений**.

3.  В колонке **Состояние** службы должно стоять **Работает**; если это не так, щелкните службу правой кнопкой мыши и выберите **Запустить**.

В-третьих, проверьте, что у службы журнала есть разрешение для записи в базу данных журнал. Служба журнала управления правами использует при работе служебную учетную запись службы управления правами. Убедитесь, что служебная учетная запись службы управления правами допускает регистрацию на сервере базе данных и что у нее есть необходимые разрешения для создания баз данных и для записи информации в файлы.

Если все необходимые условия, выполнены, остановите и перезапустите службу журнала управления правами с помощью оснастки Службы. После перезапуска службы журнала управления правами на сервере базы данных должны создаться журналы. Если в качестве сервера базы данных используется сервер SQL, убедиться в создании файлов журналов можно следующим образом.

**Чтобы убедиться, что на сервере SQL создаются файлы журналов**
1.  В окне SQL Server Enterprise Manager перейдите в базу данных журналов, раскройте элемент **Databases**, а затем раскройте базу данных, содержащую базу данных журналов службы управления правами.

2.  Выберите базу данных журналов, щелкните **Tables**, щелкните правой кнопкой мыши **DRMS\_log\_master**, а затем выберите **Open table - return all rows**. Если файлы журналов создаются, то будет виден один или несколько файлов журналов.

Восстановление базы данных конфигурации
---------------------------------------

Служба управления правами Windows не может работать без базы данных конфигурации. Если с базой данных конфигурации есть проблемы, например, база данных повреждена или отказал жесткий диск на сервере базы данных, для восстановления функций службы управления правами потребуется восстановление базой данных конфигурации из резервной копии. Для восстановления базы данных конфигурации службы управления правами из резервной копии необходима следующая информация:

-   Имя самой последней резервной копии базы данных.
-   Имя компьютера, на котором будет база данных будет восстановлена из резерва.
-   Имя учетной записи и пароль, которые изначально использовались для подготовки службы управления правами.
-   Пароль, который был изначально указан для программной защиты секретного ключа (если она использовалась).

Для восстановления из резервной копии базы данных не требуется новый сертификат лицензиара сервера или новый секретный ключ, поскольку служба управления правами сохраняет все параметры (которые она получает из резервной базы данных конфигурации).

Чтобы восстановить резервную базу данных, выполните следующие действия.

**Для восстановления резервной базы данных**
1.  В меню **Пуск** выберите **Все программы**, **Служба управления правами Windows**, а затем выберите **Администрирование службы управления правами**, чтобы открыть страницу **Глобальное администрирование**.

2.  Рядом с веб-узлом, на котором подготовлена служба управления правами, щелкните **Удалить службу управления правами с этого веб-узла**, а затем нажмите кнопку **ОК**.

3.  Восстановите файлы резервной базы данных для базы данных конфигурации. Если при резервировании была создана резервная копия базы данных журналов и требуется сохранить целостность данных, восстановите также и базу данных журналов.

    -   В случае восстановления этой системы после полного сбоя восстановите реестр, используя резервную копию состояния системы.

4.  Если восстанавливаемая база данных предназначена для одного корневого сервера сертификации, перед попыткой повторной подготовки службы измените следующий раздел реестра:

    -   На компьютерах под управлением 32-разрядной версии Windows Server 2003:
        `HKEY_LOCAL_MACHINE\Software\Microsoft\DRMS\1.0\`
    -   На компьютерах под управлением 64-разрядной версии Windows Server 2003
        `HKEY_LOCAL_MACHINE\Software\WOW6432Node\Microsoft\DRMS\1.0\`

    Добавьте следующий строковый параметр с пустым значением:

    `GicURL`

    Благодаря этому заменяется обнаружение корневого сервера сертификации с помощью Active Directory и предоставляется возможность доступа к страницам подготовки корневого сервера сертификации.

5.  Если для защиты секретного ключа служба управления правами использовался аппаратный модуль безопасности, восстановите резервную зону безопасности, чтобы можно было получить ключи.

6.  Выполните одно из следующих действий.

    -   Чтобы восстановить базу данных для одного сервера, а не кластера, щелкните Подготовить службу управления правами на этом веб-узле для веб-узла, на котором необходимо подготовить службу управления правами.
        ИЛИ
    -   Чтобы восстановить базу данных для кластера, щелкните Добавить этот сервер в кластер для веб-узла, на котором необходимо подготовить службу управления правами.

7.  Укажите учетную запись службы управления правами, которая изначально использовалась для подготовки сервера.

8.  Укажите резервную базу данных конфигурации (включая имя базы данных и имя компьютера, на котором находится эта база данных), которую необходимо использовать.

9.  Укажите тот же самый пароль, который изначально использовался для подготовки этого сервера.

10. Нажмите кнопку **Отправить**.

Запустится процесс подготовки, и служба управления правами на сервере будет подготовлена заново.

Дополнительные сведения можно найти в разделах "Планирование восстановления системы" “Резервирование и восстановление системы управления правами” документа "Планирование развертывания службы управления правами" данного комплекта.

Истек срок действия пароля учетной записи службы управления правами
-------------------------------------------------------------------

Если служба управления правами перестанет работать, то это может быть связано с истечением срока действия пароля учетной записи службы управления правами. Откройте Диспетчер IIS. Если группы приложений службы управления правами остановлены и не перезапускаются, то, возможно, истек срок действия пароля учетной записи службы управления правами.

Если истек срок действия пароля учетной записи службы управления правами, то необходимо изменить пароль на каждом сервере службы управления правами, на котором используется учетная запись с просроченным паролем, а затем повторно запустите службу IIS. Дополнительные сведения можно найти в разделе "Изменение пароля учетной записи службы управления правами" в документе "Работа с сервером службы управления правами" данного комплекта документов.

Восстановление предыдущей установки службы управления правами
-------------------------------------------------------------

В случае аппаратного или программного сбоя на сервере службы управления правами для подготовки нового экземпляра сервера можно восстановить сервер службы управления правами с использованием ранее установленной базы данных конфигурации.

| ![](/security-updates/images/Cc747605.note(WS.10).gif)Примечание                                                                                                                                                                                                                                                                                                                             |
|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Эта процедура применяется только в случае сбоя сервера, на котором запущена служба управления правами. В случае сбоя сервера, на котором запущена база данных конфигурации, обратитесь к пункту "Восстановление базы данных конфигурации" выше в данном документе. Если сервер службы управления правами является и сервером базы данных, его будет необходимо восстановить целиком из резервной копии. |

Выполните следующие действия, чтобы указать ту же базу данных конфигурации, которая использовалась для первоначальной установки.

**Для восстановления предыдущей установки службы управления правами**
1.  Зарегистрируйтесь на компьютере, который необходимо настроить в качестве сервера службы управления правами Windows, с помощью учетной записи с правами администратора. Этот компьютер должен соответствовать минимальным требованиям к системе для службы управления правами Windows. Дополнительные сведения о системных требованиях для службы управления правами можно найти в разделе "Требования к оборудованию" для службы управления правами в документе "Планирование развертывания службы управления правами" в данном комплекте документации.

2.  В случае использования аппаратного модуля безопасности для защиты секретных ключей службы управления правами убедитесь, что он настроен правильно с использованием того же параметра и области безопасности, которая использовалась в предыдущей установке службы управления правами.

3.  Установите службу управления правами на компьютер.

4.  После завершения установки службы управления правами в меню **Пуск** выберите **Все программы**, **Служба управления правами Windows**, а затем выберите **Администрирование службы управления правами Windows**, чтобы открыть страницу **Глобальное администрирование**.

5.  Рядом с веб-узлом, на котором необходимо подготовить службу управления правами, щелкните **Добавить этот сервер в кластер**.

6.  В области **Учетная запись службы управления правами** введите имя учетной записи в виде domain\_name\\user\_name, а также пароль учетной записи службы управления правами, под которой будет запускаться служба управления правами для выполнения большинства стандартных операций. Это должна быть учетная запись домена.

7.  В области **База данных конфигурации** укажите имя сервера базы данных, а также имя базы данных конфигурации исходной установки службы управления правами, которая восстанавливается.

8.  В области **Защита секретного ключа** выберите используемый этим кластером механизм для защиты секретного ключа. Если используется программная защита секретного ключа, необходимо указать пароль, который использовался для шифрования секретного ключа при первоначальной подготовке этого кластера.

9.  Нажмите кнопку **Отправить**.

Клиенты не могут открыть содержимое, защищенное с помощью службы управления правами, так как срок действия разрешений истек
---------------------------------------------------------------------------------------------------------------------------

Если срок действия разрешений пользователя истек, то пользователь не сможет использовать содержимое, защищенное с помощью службы управления правами. Если системные часы сервера службы управления правами показывают более позднее время, чем системные часы на клиенте службы управления правами, пользователь также не сможет использовать содержимое, защищенное с помощью службы управления правами, даже если срок действия разрешений не истек. Из-за рассинхронизации системных часов двух компьютеров при попытке открытия клиентским компьютером содержимого может возникнуть следующая ошибка:

**Отсутствует разрешение на открытие этого сообщения, так как срок действия разрешения истек. Открыть его с использованием другого набора учетных данных?**

Как лицензия клиента, так и лицензия содержимого действительны, но разность времени ведет к интерпретации лицензии содержимого как недействительной и выдаче пользователю сообщения об ошибке. В результате пользователя может создаться впечатление, что имеется проблема с учетной записью сертификата службы управления правами или с правами, назначенными документу. Если часы на клиенте будут в диапазоне допустимости лицензии публикации содержимого, пользователь сможет открыть содержимое.

По опыту, лучше всего синхронизировать и клиенты, и серверы в системе службы управления правами с одной и той же службой времени.

Ошибка "Доступ запрещен" при попытке службы управления правами записать информацию о событиях в журнал приложения
-----------------------------------------------------------------------------------------------------------------

По умолчанию компоненты наподобие службы управления правами, запускаемые со страницы ASP, создаются под учетной записью IUSR\_COMPUTERNAME. Эта учетная запись - член группы Гости, и потому она не имеет привилегий безопасности, необходимых для записи в журнал приложений.

Для обхода данной проблемы можно с помощью редактора реестра изменить параметр реестра, отвечающий за такое поведение.

| ![](/security-updates/images/Cc747605.Caution(WS.10).gif)Внимание!                                                                                                 |
|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Неправильное изменение реестра может привести к серьезному повреждению системы. Перед изменением реестра необходимо создать резервную копию всех ценных данных на компьютере. |

Установите значение приведенного параметра реестра 0 вместо 1 и перезагрузите компьютер для вступления изменений в действие.

`HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\EventLog\Application`

Имя: `RestrictGuestAccess`

Наберите: `REG_DWORD`

| ![](/security-updates/images/Cc747605.note(WS.10).gif)Примечание                 |
|---------------------------------------------------------------------------------------------|
| Этот позволяет всем учетным записям из группы Гости производить запись в журнал приложений. |

Дополнительные сведения о причине этой ошибки можно найти в статье о включении ведения журнала со страниц ASP в [базе знаний Microsoft Knowledge Base](http://go.microsoft.com/fwlink/?linkid=44167).
