---
TOCTitle: Наблюдение за службой очередей сообщений
Title: Наблюдение за службой очередей сообщений
ms:assetid: 'a7109399-3a84-4681-874b-f6ea1646b0a0'
ms:contentKeyID: 18124486
ms:mtpsurl: 'https://technet.microsoft.com/ru-ru/library/Cc747716(v=WS.10)'
---

Наблюдение за службой очередей сообщений
========================================

При ведении журналов службы управления правами для отправки событий в базу данных журналов используется служба очередей сообщений (известная как MSMQ). Каждый входной сервер службы управления правами отправляет сообщения в службу очередей сообщений и службу прослушивателя на каждом входном сервере, получает сообщения журналов из очереди службы очередей сообщений, а также записывает их в базу данных журналов. Если база данных журналов или сервер базы данных станут недоступны или будет остановлена служба прослушивателя регистрации, служба очередей сообщений будет хранить сообщения в очереди. Если планируется завершить работу базы данных журналов или сервера базы данных, рекомендуется сначала завершить работу службы прослушивателя регистрации на каждом входном сервере, а затем перезапустить службу прослушивателя регистрации на каждом входном сервере после перезапуска базы данных или сервера базы данных.

Если база данных не работает, а служба прослушивателя регистрации все еще запущена, службе прослушивателя регистрации не удастся записать сообщения регистрации в базу данных. Служба прослушивателя регистрации будет перемещать сообщения в очередь "недоставленных сообщений" службы очередей сообщений до тех пор, пока не появится доступ к базе данных, и с этого момента новые сообщения регистрации будут записываться в базу данных. Сообщения в очереди недоставленных сообщений не будут автоматически записаны в базу данных журналов. Чтобы просмотреть и удалить сообщения в очереди недоставленных сообщений, выполните следующие шаги:

1.  Откройте в консоли MMC оснастку "Управление компьютером". Для этого щелкните кнопку **Пуск**, выберите **Все программы**, **Администрирование**, а затем щелкните **Управление сервером**.
2.  В разделе Службы и приложения в дереве консоли щелкните Очередь сообщений, затем Частные очереди.
3.  Будут отображены две очереди. У обеих очередей имя начинается с "**drms\_logging**". Далее следует имя кластера. Одна из очередей будет именоваться "**drms\_logging\_***&lt;имя кластера&gt;***\_deadletter**". Это очередь недоставленных сообщений. Щелкните имя очереди, а затем щелкните очередь Сообщения очереди.
4.  Дважды щелкните каждое сообщение, чтобы просмотреть его свойства.
5.  Чтобы удалить очередь, щелкните правой кнопкой мыши очередь **Сообщения очереди**, выберите **Все задачи**, а затем щелкните **Очистить**.

В конфигурации по умолчанию служба очередей сообщений будет хранить все сообщения очереди, пока не будет достигнут предел свободного дискового пространства на сервере. Если службой очередей сообщений будет использовано все свободное место на жестком диске, сервер службы управления правами будет не в состоянии обслуживать запросы клиентов. Для предотвращения такой ситуации выполните следующие шаги, чтобы ограничить объем дискового пространства, который может быть использован службой очередей сообщений для очереди.

1.  Откройте в консоли MMC оснастку "Управление компьютером". Для этого щелкните кнопку Пуск, выберите Все программы, Администрирование, а затем щелкните Управление сервером.
2.  В разделе Службы и приложения в дереве консоли щелкните Очередь сообщений, затем Частные очереди.
3.  Будут отображены две очереди. У обеих очередей имя начинается с "drms\_logging". Выполните следующие шаги для каждой очереди.
    -   Щелкните Свойства.
    -   Установите флажок Предел хранения сообщений (КБ), а затем введите общий размер (в килобайтах) для всех сообщений, которые можно будет хранить в очереди.

В случае переполнения очереди сообщения, поступающие от службы управления правами, будут отбрасываться, и в журнал системных событий будет отправлено следующее сообщение о событии, соответствующее событию с кодом 48:

"Не удалось отправить набор свойств в очередь сообщений".

Рекомендуется настроить системные средства наблюдения, чтобы своевременно получать извещение об этом событии, так как оно сигнализирует о проблеме, связанной с базой данных журналов.
