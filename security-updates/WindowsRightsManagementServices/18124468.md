---
TOCTitle: Перенос базы данных конфигурации
Title: Перенос базы данных конфигурации
ms:assetid: '980e3e94-7d28-40dd-ad01-d34eb3c8d8e6'
ms:contentKeyID: 18124468
ms:mtpsurl: 'https://technet.microsoft.com/ru-ru/library/Cc747607(v=WS.10)'
---

Перенос базы данных конфигурации
================================

В некоторых случаях требуется вывести из эксплуатации сервер базы данных. Обновление оборудования сервера базы данных службы управления правами — один из таких примеров. Перед выводом сервера базы данных из эксплуатации, базу данных конфигурации необходимо перенести на другой сервер базы данных. Чтобы защитить данные в базе данных конфигурации, включая содержащиеся в ней пары ключей, следует тщательно запланировать и реализовать перенос.

Для сервера базы данных службы управления правами рекомендуется создать псевдоним CNAME, а затем настроить службу управления правами на его использование. Это устраняет необходимость в ручном изменении имени сервера базы данных в базе данных конфигурации службы управления правами в случае изменения имени сервера. При использовании псевдонима CNAME требуется только обновить запись псевдонима.

Перед началом переноса базы данных конфигурации убедитесь в наличии следующей информации:

-   имя и пароль учетной записи, которая изначально использовалась для подготовки серверов кластера службы управления правами, использующего эту базу данных;
-   пароль закрытого ключа службы управления правами, который изначально был указан во время подготовки, если для хранения закрытого ключа службы управления правами используется поставщик программных служб шифрования. Если для хранения закрытого ключа службы управления правами используется аппаратный модуль безопасности (HSM), выполнять данный шаг не требуется.

| ![](/security-updates/images/Cc747607.note(WS.10).gif)Примечание                                                                                                                                             |
|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Для переноса базы данных конфигурации не требуется новый сертификат лицензиара сервера или новый закрытый ключ сервера, так как в службе управления правами сохраняются настройки из исходной базы данных конфигурации. |

Перед выполнением любых операций на сервере базы данных следует создать резервные копии баз данных службы управления правами. Если такой возможности нет, необходимо, как минимум, экспортировать свой сертификат лицензиара сервера. Дополнительные сведения об экспорте сертификата лицензиара сервера см. в разделе [Как экспортировать свой сертификат лицензиара сервера в файл](https://technet.microsoft.com/d683a629-71b3-4b11-932b-4ab0317334af). Если во время переноса баз данных возникает ошибка, сертификат лицензиара сервера можно импортировать в новую установку службы управления правами и использовать содержимое, защищенное с помощью более старой установки.

Для переноса базы данных конфигурации выполните следующие действия.

-   Обновите базу данных конфигурации службы управления правами, чтобы учесть имя нового сервера баз данных.
-   Обновите файлы web.config и реестр на каждом сервере кластера службы управления правами, чтобы использовать имя нового сервера баз данных

| ![](/security-updates/images/Cc747607.Important(WS.10).gif)Важно!                                                                                                          |
|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| В данном разделе предполагается, что базы данных службы управления правами уже скопированы на новый сервер базы данных, на котором размещаются базы данных службы управления правами. |

Обновите базу данных конфигурации службы управления правами, чтобы использовать имя нового сервера баз данных.
--------------------------------------------------------------------------------------------------------------

Имя сервера баз данных, на котором размещаются базы данных службы управления правами, хранятся в базе данных конфигурации службы управления правами. После переноса файлов баз данных на новый сервер базы данных необходимо обновить базу данных конфигурации службы управления правами. Это можно сделать с помощью средства RMS Config Editor из набора средств администрирования службы управления правами или с помощью SQL Management Studio.

Чтобы обновить имя сервера баз данных службы управления правами с помощью средства RMS Config Editor, выполните следующие действия.

**Порядок обновления базы данных конфигурации службы управления правами с помощью RMS Config Editor**
1.  Войдите в систему сервера службы управления правами кластера как член роли базы данных "Системные администраторы".

2.  Установите набор средств администрирования службы управления правами, который можно загрузить из центра загрузки Майкрософт ([http://go.microsoft.com/fwlink/?LinkId=98961](http://go.microsoft.com/fwlink/?linkid=98961)).

3.  Перейдите к разделу %SystemDrive%:\\Program Files\\RMS SP2 Administration Toolkit\\RMSConfigEditor, а затем дважды щелкните **RMSCONFIGEDITOR.EXE**.

4.  В поле **Сервер** введите имя нового сервера, на котором размещается база данных конфигурации службы управления правами, а затем нажмите кнопку **Перейти**.

5.  В поле **База данных** выберите **DRMS\_Config\_***&lt;имя кластера RMS&gt;***\_***&lt;порт&gt;*, где *&lt;имя кластера RMS&gt;* — имя кластера службы управления правами, а *&lt;порт&gt;* — TCP-порт, используемый для связи службой управления правами, а затем нажмите кнопку **Перейти**.

6.  Щелкните **DRMS\_ClusterPolicies**.

7.  В области результатов измените значение в столбце **PolicyData** строки **LoggingDatabaseServer** на имя нового сервера баз данных службы управления правами.

8.  Выберите **Постоянный**.

9.  Измените значение в столбце **PolicyData** строки **CertificationUserKeyStorageConnectionString**, чтобы учесть новый сервер баз данных. Данное значение должно иметь вид **data source=***&lt;имя нового сервера баз данных&gt;***;integrated**, где *&lt;имя нового сервера баз данных&gt;* — имя нового сервера баз данных.

10. Выберите **Постоянный**.

11. Повторите шаги 9–10 для каждого значения в столбце **PolicyData** строки **DirectoryServicesCacheDatabase**.

12. В левой панели щелкните **DRMS\_PluginProperties**.

13. Для **PropertyID** 101 с именем **PERSISTENT\_STORAGE** измените столбец **PropertyValue**, чтобы учесть новый сервер баз данных. Данное значение должно иметь вид **data source=***&lt;имя нового сервера баз данных&gt;***;integrated**, где *&lt;имя нового сервера баз данных&gt;* — имя нового сервера баз данных.

14. Выберите **Постоянный**.

15. Закройте редактор RMS Config Editor.

Чтобы обновить базу данных конфигурации службы управления правами с помощью SQL Server Management Studio, выполните следующие действия.

**Порядок обновления базы данных конфигурации службы управления правами с помощью SQL Server Management Studio**
1.  Войдите в систему сервера базы данных конфигурации службы управления правами с правами локального администратора или любой другой учетной записи пользователя, являющейся членом локальной группы администраторов.

2.  Нажмите кнопку **Пуск**, выберите **Все программы**, **Microsoft SQL Server 2005**, а затем — **SQL Server Management Studio**.

3.  На странице **Подключение к серверу** убедитесь, что имя нового сервера баз данных указано в поле **Имя сервера**, а затем нажмите кнопку **Подключиться**.

4.  Раскройте узлы **Базы данных**, **DRMS\_Config\_***&lt;имя кластера RMS&gt;***\_***&lt;порт&gt;*, а затем — **Таблицы**.

5.  Щелкните правой кнопкой мыши **DRMS\_ClusterPolicies**, а затем выберите команду **Открыть таблицу**.

6.  В области результатов измените значение в столбце **PolicyData** строки **LoggingDatabaseServer** на имя нового сервера баз данных службы управления правами.

7.  Измените значение в столбце **PolicyData** строки **CertificationUserKeyStorageConnectionString**, чтобы учесть новый сервер баз данных. Данное значение должно иметь вид **data source=***&lt;имя нового сервера баз данных&gt;***;integrated**, где *&lt;имя нового сервера баз данных&gt;* — имя нового сервера баз данных.

8.  Повторите шаги 6–7 для каждого значения в столбце **PolicyData** строки **DirectoryServicesCacheDatabase**.

9.  В панели обозревателя объектов щелкните правой кнопкой мыши **DRMS\_PluginProperties**, а затем выберите команду **Открыть таблицу**.

10. Для **PropertyID** 101 с именем **PERSISTENT\_STORAGE** измените столбец **PropertyValue**, чтобы учесть новый сервер баз данных. Данное значение должно иметь вид **data source=***&lt;имя нового сервера баз данных&gt;***;integrated**, где *&lt;имя нового сервера баз данных&gt;* — имя нового сервера баз данных.

11. Закройте Microsoft SQL Server Management Studio.

Каждый сервер кластера службы управления правами настройте на использование имени нового сервера баз данных.
------------------------------------------------------------------------------------------------------------

Чтобы каждый сервер кластера службы управления правами настроить на использование имени нового сервера баз данных, необходимо обновить файлы web.config и три параметра реестра. После завершения обновления необходимо перезапустить Internet Information Services (IIS), чтобы изменения вступили в силу.

Обновление файлов web.config на каждом сервере кластера службы управления правами:

**Порядок обновления файлов web.config на каждом сервере кластера службы управления правами**
1.  Войдите в систему сервера данного кластера службы управления правами как член локальной группы администраторов.

2.  Перейдите к каталогу %Systemdrive%\\inetpub\\wwwroot\\\_wmcs\\admin.

3.  Дважды щелкните **web.config**, установите флажок **Выбрать программу из списка**, а затем нажмите кнопку **ОК**.

4.  Щелкните **Блокнот**, удалите флажок **Использовать выбранную программу для всех файлов такого типа**, а затем нажмите кнопку **ОК**.

5.  Нажмите кнопку **Изменить**, а затем — **Заменить**.

6.  В поле **Найти** введите имя выводимого из эксплуатации сервера базы данных, на котором размещаются базы данных службы управления правами.

7.  В поле **Заменить** введите имя нового сервера базы данных, на котором размещаются базы данных службы управления правами.

8.  Нажмите кнопку **Заменить все**, а затем — кнопку **Отмена**.

9.  В меню **Файл** выберите команду **Сохранить**.

10. Закройте Блокнот.

11. Повторите действия 2–9 для файлов web.config, расположенных в каталогах %Systemdrive%\\inetpub\\wwwroot\\\_wmcs\\certification и %Systemdrive%\\inetpub\\wwwroot\\\_wmcs\\licensing.

12. Повторите действия 1–11 для каждого сервера в кластере службы управления правами.

Наконец, обновите реестр на каждом сервере кластера службы управления правами, чтобы использовать имя нового сервера баз данных.

| ![](/security-updates/images/Cc747607.Caution(WS.10).gif)Внимание!                                                                                                |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Неверное редактирование реестра может привести к серьезным повреждениям системы. Перед внесением изменений следует сделать резервную копию всех ценных данных на компьютере. |

**Порядок обновления реестра на каждом сервере кластера службы управления правами**
1.  Войдите в систему сервера данного кластера службы управления правами как член локальной группы администраторов.

2.  Нажмите кнопку **Пуск**, затем выберите команду **Выполнить**.

3.  Введите **regedit.exe**, а затем нажмите кнопку **ОК**.

4.  Перейдите к разделу **HKEY\_LOCAL\_MACHINE\\Software\\Microsoft\\DRMS\\1.0\\KeyProtection**.

5.  Измените параметр реестра PASSWORDDERIVEDKEY\_*&lt;имя старого сервера баз данных&gt;*\_DRMS\_CONFIG\_*&lt;имя кластера RMS&gt;*\_*&lt;порт&gt;* на

    PASSWORDDERIVEDKEY\_*&lt;имя старого сервера базы данных&gt;*\_DRMS\_CONFIG\_*&lt;имя кластера RMS&gt;*\_*&lt;порт&gt;*

    где:

    -   *&lt;имя нового сервера баз данных&gt;* — это имя старого сервера баз данных;
    -   *&lt;имя кластера RMS&gt;* — имя кластера службы управления правами;
    -   *&lt;порт&gt;* — TCP-порт, используемый службой управления правами для связи;
    -   *&lt;имя нового сервера баз данных&gt;* — это имя нового сервера баз данных.

6.  Перейдите к разделу **HKEY\_LOCAL\_MACHINE\\System\\CurrentControlSet001\\Services\\DRMS\_Logging\_&lt;RMS cluster name&gt;\_&lt;port&gt;\\Params**.

7.  Измените параметр реестра **ConnectionString** так, чтобы значение источника данных соответствовало имени нового сервера базы данных.

8.  Повторите действия 6–7 для раздела **HKEY\_LOCAL\_MACHINE\\System\\CurrentControlSet\\Services\\DRMS\_Logging\_&lt;RMS cluster name&gt;\_&lt;port&gt;\\Params**.

9.  В командной строке введите **IISRESET** и нажмите клавишу ВВОД.

10. Повторите действия 1–9 для каждого сервера в кластере службы управления правами.
